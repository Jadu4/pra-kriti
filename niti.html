<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>üí´ –¶–µ–Ω—Ç—Ä –ù–∏—Ç–µ–π + –ü–æ—Ç–æ–∫ –°–æ–∑–Ω–∞–Ω–∏—è</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f4f7fa;
      color: #2c3e50;
      margin: 0;
      padding: 0;
    }
    header {
      background: #2c3e50;
      color: white;
      padding: 1em;
      text-align: center;
    }
    main {
      max-width: 960px;
      margin: auto;
      padding: 2em;
    }
    .section {
      background: white;
      padding: 1.5em;
      margin-bottom: 1.5em;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }
    h2 {
      color: #34495e;
    }
    label {
      display: block;
      margin-top: 1em;
      font-weight: bold;
    }
    input,
    select,
    textarea {
      width: 100%;
      padding: 0.5em;
      margin-top: 0.3em;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    button {
      margin-top: 1em;
      padding: 0.6em 1.2em;
      background: #2980b9;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    ul {
      margin-left: 1.5em;
    }
    canvas {
      max-width: 100%;
    }
    pre {
      background: #f9f9f9;
      padding: 1em;
      border-radius: 5px;
      overflow-x: auto;
    }
    .chart-container {
      position: relative;
      height: 300px;
      margin: 1em 0;
    }
    .math {
      font-family: "Times New Roman", serif;
      font-style: italic;
    }
    .positive { color: #2ecc71; }
    .negative { color: #e74c3c; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 15px 0;
    }
    th, td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }
    th {
      background-color: #f8f9fa;
    }
  </style>
</head>
<body>

<header>
  <h1>üí´ –¶–µ–Ω—Ç—Ä –ù–∏—Ç–µ–π + –ü–æ—Ç–æ–∫ –°–æ–∑–Ω–∞–Ω–∏—è</h1>
</header>

<main>

  <!-- 1. –î–Ω–µ–≤–Ω–∏–∫ –Ω–∏—Ç–µ–π -->
  <div class="section">
    <h2>üìù –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –Ω–∏—Ç–µ–π</h2>
    <label>–î–∞—Ç–∞:</label>
    <input type="date" id="thread-date">
    <label>–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–∏—Ç–∏:</label>
    <input type="text" id="thread-name" placeholder="–ü—Ä–∏–º–µ—Ä: '–Ω–∏—Ç—å —Å—Ç—Ä–∞—Ö–∞' –∏–ª–∏ '–Ω–∏—Ç—å –º–∏—Å—Å–∏–∏'">
    <label>–¢–∏–ø –Ω–∏—Ç–∏:</label>
    <select id="thread-type">
      <option value="—Ñ–∏–∑–∏—á–µ—Å–∫–∞—è">–§–∏–∑–∏—á–µ—Å–∫–∞—è</option>
      <option value="—ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è">–≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è</option>
      <option value="–º–µ–Ω—Ç–∞–ª—å–Ω–∞—è">–ú–µ–Ω—Ç–∞–ª—å–Ω–∞—è</option>
      <option value="—Å–æ—Ü–∏–∞–ª—å–Ω–∞—è">–°–æ—Ü–∏–∞–ª—å–Ω–∞—è</option>
      <option value="–¥—É—Ö–æ–≤–Ω–∞—è">–î—É—Ö–æ–≤–Ω–∞—è</option>
      <option value="–≤—Ä–µ–º–µ–Ω–Ω–∞—è">–í—Ä–µ–º–µ–Ω–Ω–∞—è</option>
    </select>
    <label>–°–æ—Å—Ç–æ—è–Ω–∏–µ:</label>
    <input type="text" id="thread-state" placeholder="–ö–∞–∫ –ø—Ä–æ—è–≤–ª—è–µ—Ç—Å—è? –ß—Ç–æ –≤—ã–∑—ã–≤–∞–µ—Ç?">
    <label>–û–ø–∏—Å–∞–Ω–∏–µ:</label>
    <textarea id="thread-desc" rows="4" placeholder="–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è –Ω–∏—Ç–∏"></textarea>
    <label>–ì–∞—Ä–º–æ–Ω–∏–∑–∞—Ü–∏—è:</label>
    <textarea id="thread-harmonize" rows="3" placeholder="–ß—Ç–æ –ø–æ–º–æ–∂–µ—Ç –≤—ã—Ä–æ–≤–Ω—è—Ç—å —ç—Ç—É –Ω–∏—Ç—å?"></textarea>
    <button onclick="saveThread()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å</button>
  </div>

  <!-- 2. –†–∞—Å—á—ë—Ç –ø–æ—Ç–æ–∫–∞ -->
  <div class="section">
    <h2>üßÆ –ê–Ω–∞–ª–∏–∑ –ü–æ—Ç–æ–∫–∞ –°–æ–∑–Ω–∞–Ω–∏—è</h2>
    <p><strong>–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Ñ–æ–∫—É—Å–∞ –∏ –∫–æ–º–ø–ª–µ–º–µ–Ω—Ç–∞—Ä–Ω–æ—Å—Ç–∏ –Ω–∏—Ç–µ–π.</strong></p>
    
    <label>–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏:</label>
    <input type="text" id="task-name" placeholder="–û–ø–∏—à–∏—Ç–µ —Ç–µ–∫—É—â—É—é –∑–∞–¥–∞—á—É">
    
    <label>–í—Ä–µ–º—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ T (–º–∏–Ω):</label>
    <input type="number" id="T" value="5">
    
    <label>–ù–∞—á–∞–ª—å–Ω—ã–π —Ñ–æ–∫—É—Å A‚ÇÄ (%):</label>
    <input type="number" id="A0" value="100" min="0" max="100">
    
    <label>–¢–µ–∫—É—â–∏–π —Ñ–æ–∫—É—Å A‚Çú (%):</label>
    <input type="number" id="At" value="30" min="0" max="100">
    
    <label>–í–µ—Å–∞ –≤–æ–ª–æ–∫–æ–Ω k·µ¢ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é):</label>
    <input type="text" id="ki" value="0.5, 0.3, 0.2" placeholder="0.5, 0.3, 0.2">
    
    <label>–î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å w·µ¢ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é):</label>
    <input type="text" id="wi" value="1.0, 0.8, 0.5" placeholder="1.0, 0.8, 0.5">
    
    <label>–ü–æ–º–µ—Ö–∏ d·µ¢ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é):</label>
    <input type="text" id="di" value="1.0, 1.2, 0.9" placeholder="1.0, 1.2, 0.9">
    
    <button onclick="calculateFlow()">üìä –†–∞—Å—Å—á–∏—Ç–∞—Ç—å</button>
  </div>

  <!-- 3. –í—ã–≤–æ–¥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ -->
  <div id="flow-result" style="margin-top: 20px;"></div>

  <!-- 4. –ì—Ä–∞—Ñ–∏–∫ –¥–∏–Ω–∞–º–∏–∫–∏ -->
  <div class="section">
    <h2>üìà –ì—Ä–∞—Ñ –¥–∏–Ω–∞–º–∏–∫–∏ –Ω–∏—Ç–µ–π</h2>
    <canvas id="threadChart" height="100"></canvas>
  </div>

  <!-- 5. –ò—Å—Ç–æ—Ä–∏—è –∑–∞–ø–∏—Å–µ–π -->
  <div class="section">
    <h2>üìñ –ò—Å—Ç–æ—Ä–∏—è –∑–∞–ø–∏—Å–µ–π</h2>
    <ul id="history-list"></ul>
  </div>

  <!-- 6. –ß–∞–∫—Ä—ã -->
  <div class="section">
    <h2>üåÄ –ù–∏—Ç–∏ –∏ —á–∞–∫—Ä—ã</h2>
    <ul>
      <li><strong>–ö–æ—Ä–Ω–µ–≤–∞—è</strong>: —Ñ–∏–∑–∏—á–µ—Å–∫–æ–µ –≤—ã–∂–∏–≤–∞–Ω–∏–µ ‚Üí —Ñ–∏–∑–∏—á–µ—Å–∫–∏–µ –∏ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –Ω–∏—Ç–∏</li>
      <li><strong>–°–∞–∫—Ä–∞–ª—å–Ω–∞—è</strong>: —ç–º–æ—Ü–∏–∏ –∏ —Ç–≤–æ—Ä—á–µ—Å—Ç–≤–æ ‚Üí —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –∏ —Å–æ—Ü–∏–∞–ª—å–Ω—ã–µ –Ω–∏—Ç–∏</li>
      <li><strong>–°–æ–ª–Ω–µ—á–Ω–æ–µ —Å–ø–ª–µ—Ç–µ–Ω–∏–µ</strong>: –ª–∏—á–Ω–∞—è —Å–∏–ª–∞ ‚Üí –º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ –∏ —Å–æ—Ü–∏–∞–ª—å–Ω—ã–µ –Ω–∏—Ç–∏</li>
      <li><strong>–°–µ—Ä–¥—Ü–µ</strong>: –ª—é–±–æ–≤—å ‚Üí –¥—É—Ö–æ–≤–Ω—ã–µ –∏ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –Ω–∏—Ç–∏</li>
      <li><strong>–ì–æ—Ä–ª–æ</strong>: –≤—ã—Ä–∞–∂–µ–Ω–∏–µ ‚Üí –º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ –∏ —Å–æ—Ü–∏–∞–ª—å–Ω—ã–µ –Ω–∏—Ç–∏</li>
      <li><strong>–¢—Ä–µ—Ç–∏–π –≥–ª–∞–∑</strong>: –∏–Ω—Ç—É–∏—Ü–∏—è ‚Üí –¥—É—Ö–æ–≤–Ω—ã–µ –∏ –º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ –Ω–∏—Ç–∏</li>
      <li><strong>–ú–∞–∫—É—à–∫–∞</strong>: —Å–≤—è–∑—å —Å –í—ã—Å—à–∏–º –Ø ‚Üí –¥—É—Ö–æ–≤–Ω—ã–µ –∏ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –Ω–∏—Ç–∏</li>
    </ul>
  </div>

  <!-- 7. –ú–µ–¥–∏—Ç–∞—Ü–∏—è -->
  <div class="section">
    <h2>üßò‚Äç‚ôÄÔ∏è –ú–µ–¥–∏—Ç–∞—Ü–∏—è –¥–ª—è —Ç–æ—Ä–æ–≤–æ–≥–æ –ø–æ–ª—è</h2>
    <p><strong>–¶–µ–ª—å:</strong> –æ—á–∏—Å—Ç–∫–∞ –∏ —É—Å–∏–ª–µ–Ω–∏–µ –Ω–∏—Ç–µ–π —á–µ—Ä–µ–∑ —Ä–∞–±–æ—Ç—É —Å —Ç–æ—Ä–æ–º.</p>
    <ol>
      <li>–ó–∞–π–º–∏—Ç–µ —É–¥–æ–±–Ω—É—é –ø–æ–∑—É, –∑–∞–∫—Ä–æ–π—Ç–µ –≥–ª–∞–∑–∞.</li>
      <li>–ü—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ, –∫–∞–∫ –≤–∞—à–µ —Ç–æ—Ä–æ–≤–æ–µ –ø–æ–ª–µ –Ω–∞—á–∏–Ω–∞–µ—Ç —Å–≤–µ—Ç–∏—Ç—å—Å—è.</li>
      <li>–û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –æ–¥–Ω–æ–π –∏–∑ –≤–∞—à–∏—Ö –Ω–∏—Ç–µ–π.</li>
      <li>–ü–æ–ø—Ä–æ—Å–∏—Ç–µ –µ—ë –æ—Å–≤–µ—Ç–∏—Ç—å—Å—è –∏ –Ω–∞—á–∞—Ç—å –æ—á–∏—â–∞—Ç—å—Å—è.</li>
      <li>–ü–æ—á—É–≤—Å—Ç–≤—É–π—Ç–µ, –∫–∞–∫ –æ–Ω–∞ –Ω–∞–ø–æ–ª–Ω—è–µ—Ç –≤–∞—Å —Å–∏–ª–æ–π.</li>
      <li>–ó–∞–≤–µ—Ä—à–∏—Ç–µ –º–µ–¥–∏—Ç–∞—Ü–∏—é, –ø–æ–±–ª–∞–≥–æ–¥–∞—Ä–∏–≤ –∑–∞ –ø—Ä–æ—Ü–µ—Å—Å.</li>
    </ol>
  </div>

  <!-- 8. –≠–∫—Å–ø–æ—Ä—Ç / –ò–º–ø–æ—Ä—Ç -->
  <div class="section">
    <h2>üì• –≠–∫—Å–ø–æ—Ä—Ç / –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö</h2>
    <button onclick="exportData()">üì§ –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
    <input type="file" id="importFile" accept=".json" onchange="importData()">
  </div>

</main>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- –û—Å–Ω–æ–≤–Ω–æ–π JS -->
<script>
  const STORAGE_KEY = 'threads_db';
  const FLOW_STORAGE_KEY = 'flow_results_db';
  let db = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
  let flowResults = JSON.parse(localStorage.getItem(FLOW_STORAGE_KEY)) || [];

  // –ù–∞–∑–≤–∞–Ω–∏—è –≤–æ–ª–æ–∫–æ–Ω
  const fiberNames = {
    1: "–ö–æ–≥–Ω–∏—Ç–∏–≤–Ω–æ–µ",
    2: "–≠–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–æ–µ",
    3: "–ò–Ω—Ç—É–∏—Ç–∏–≤–Ω–æ–µ"
  };

  function saveThread() {
    const date = document.getElementById('thread-date').value;
    const name = document.getElementById('thread-name').value;
    const type = document.getElementById('thread-type').value;
    const state = document.getElementById('thread-state').value;
    const desc = document.getElementById('thread-desc').value;
    const harmonize = document.getElementById('thread-harmonize').value;

    if (!date || !name) return alert("‚ùó –£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É –∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–∏—Ç–∏");

    const entry = { 
      date, 
      name, 
      type, 
      state, 
      desc, 
      harmonize,
      timestamp: new Date().toISOString()
    };
    
    db.push(entry);
    localStorage.setItem(STORAGE_KEY, JSON.stringify(db));
    updateHistory();
    updateChart();
    clearForm();
  }

  function clearForm() {
    document.getElementById('thread-date').value = '';
    document.getElementById('thread-name').value = '';
    document.getElementById('thread-type').value = '—Ñ–∏–∑–∏—á–µ—Å–∫–∞—è';
    document.getElementById('thread-state').value = '';
    document.getElementById('thread-desc').value = '';
    document.getElementById('thread-harmonize').value = '';
  }

  function updateHistory() {
    const list = document.getElementById('history-list');
    list.innerHTML = '';
    
    // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –¥–∞—Ç–µ (–Ω–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É)
    const sortedEntries = [...db].sort((a, b) => 
      new Date(b.timestamp) - new Date(a.timestamp));
    
    sortedEntries.forEach(e => {
      const item = document.createElement('li');
      item.innerHTML = `
        <strong>[${e.date}] ${e.name}</strong>
        <br>${e.state}
        <br><small>${e.type}</small>
        <button onclick="deleteThread('${e.timestamp}')" style="float: right; padding: 2px 5px; font-size: 12px;">√ó</button>
      `;
      list.appendChild(item);
    });
  }

  function deleteThread(timestamp) {
    db = db.filter(e => e.timestamp !== timestamp);
    localStorage.setItem(STORAGE_KEY, JSON.stringify(db));
    updateHistory();
    updateChart();
  }

  function updateChart() {
    const ctx = document.getElementById('threadChart').getContext('2d');
    const labels = [...new Set(db.map(e => e.date))].sort();
    const types = ['—Ñ–∏–∑–∏—á–µ—Å–∫–∞—è', '—ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è', '–º–µ–Ω—Ç–∞–ª—å–Ω–∞—è', '—Å–æ—Ü–∏–∞–ª—å–Ω–∞—è', '–¥—É—Ö–æ–≤–Ω–∞—è', '–≤—Ä–µ–º–µ–Ω–Ω–∞—è'];
    
    const datasets = types.map(type => ({
      label: type,
      data: labels.map(date => db.filter(e => e.date === date && e.type === type).length),
      borderWidth: 1,
      fill: true,
      tension: 0.3
    }));
    
    if (window.threadChartInstance) {
      window.threadChartInstance.destroy();
    }
    
    window.threadChartInstance = new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets
      },
      options: {
        responsive: true,
        scales: {
          y: { beginAtZero: true }
        }
      }
    });
  }

  function calculateFlow() {
    const T = parseFloat(document.getElementById('T').value);
    const A0 = parseFloat(document.getElementById('A0').value);
    const At = parseFloat(document.getElementById('At').value);
    const task = document.getElementById('task-name').value;
    const ki = document.getElementById('ki').value.split(',').map(x => parseFloat(x.trim())).filter(x => !isNaN(x));
    const wi = document.getElementById('wi').value.split(',').map(x => parseFloat(x.trim())).filter(x => !isNaN(x));
    const di = document.getElementById('di').value.split(',').map(x => parseFloat(x.trim())).filter(x => !isNaN(x));

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö
    let errorMessage = "";
    if (ki.length !== wi.length || wi.length !== di.length) {
      errorMessage = "‚ùå –î–ª–∏–Ω—ã –º–∞—Å—Å–∏–≤–æ–≤ ki, wi, di –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç";
    } else if (isNaN(T) || isNaN(A0) || isNaN(At)) {
      errorMessage = "‚ùå T, A0, At –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —á–∏—Å–ª–∞–º–∏";
    }

    if (errorMessage) {
      document.getElementById('flow-result').innerHTML = `
        <div class="section">
          <h3>–û—à–∏–±–∫–∞</h3>
          <p>${errorMessage}</p>
        </div>
      `;
      return;
    }

    // –†–∞—Å—á—ë—Ç—ã
    const fp = (1 / T) * Math.log(A0 / At);
    const C = ki.reduce((sum, k, i) => sum + (k * wi[i] / di[i]), 0).toFixed(2);
    
    const fibers = ki.map((k, i) => ({
      num: i + 1,
      k: k,
      w: wi[i],
      d: di[i],
      contribution: (k * wi[i] / di[i]).toFixed(2),
      status: di[i] > 1.1 ? "‚ùó –ü–æ–º–µ—Ö–∏" : wi[i] < 0.5 ? "üîç –°–ª–∞–±–æ" : "‚úÖ –ù–æ—Ä–º–∞"
    }));

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    const flowResult = {
      timestamp: new Date().toISOString(),
      task,
      T, A0, At, fp, C,
      fibers: [...fibers],
      date: new Date().toLocaleDateString()
    };
    
    flowResults.push(flowResult);
    localStorage.setItem(FLOW_STORAGE_KEY, JSON.stringify(flowResults));

    // –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
    let resultHTML = `
      <div class="section">
        <h3>üåä –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ—Ç–æ–∫–∞ ${task ? `"${task}"` : ''}</h3>
        
        <h4>üìà –†–µ–∑–æ–Ω–∞–Ω—Å–Ω–∞—è —á–∞—Å—Ç–æ—Ç–∞: ${fp.toFixed(2)} –ì—Ü</h4>
        <p class="math">f‚Çö = (1/T) ¬∑ ln(A‚ÇÄ/A‚Çú)</p>
        
        <table>
          <tr>
            <th>–ü–∞—Ä–∞–º–µ—Ç—Ä</th>
            <th>–ó–Ω–∞—á–µ–Ω–∏–µ</th>
            <th>–ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è</th>
          </tr>
          <tr>
            <td class="math">T</td>
            <td>${T} –º–∏–Ω</td>
            <td>${T} –º–∏–Ω—É—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</td>
          </tr>
          <tr>
            <td class="math">A‚ÇÄ ‚Üí A‚Çú</td>
            <td>${A0}% ‚Üí ${At}%</td>
            <td>–ü–æ—Ç–µ—Ä—è —Ñ–æ–∫—É—Å–∞: ${(100 - At).toFixed(0)}%</td>
          </tr>
          <tr>
            <td class="math">f‚Çö</td>
            <td>${fp.toFixed(2)} –ì—Ü</td>
            <td>${fp < 0.3 ? "–ì–ª—É–±–æ–∫–∏–π –ø–æ—Ç–æ–∫" : "–ê–∫—Ç–∏–≤–Ω—ã–π —Ä–µ–∂–∏–º"}</td>
          </tr>
        </table>
        
        <h4>üßÆ –ö–æ–º–ø–ª–µ–º–µ–Ω—Ç–∞—Ä–Ω–æ—Å—Ç—å –≤–æ–ª–æ–∫–æ–Ω: ${C} ${C >= 1 ? "‚úÖ" : "‚ùå"}</h4>
        <p class="math">C = Œ£(k·µ¢¬∑w·µ¢/d·µ¢)</p>
        
        <table>
          <tr>
            <th>–í–æ–ª–æ–∫–Ω–æ</th>
            <th class="math">k·µ¢</th>
            <th class="math">w·µ¢</th>
            <th class="math">d·µ¢</th>
            <th>–í–∫–ª–∞–¥</th>
            <th>–°—Ç–∞—Ç—É—Å</th>
          </tr>
          ${fibers.map(f => `
            <tr>
              <td>${fiberNames[f.num] || `–í–æ–ª–æ–∫–Ω–æ ${f.num}`}</td>
              <td>${f.k}</td>
              <td>${f.w}</td>
              <td>${f.d}</td>
              <td>${f.contribution}</td>
              <td class="${f.status.includes('‚úÖ') ? 'positive' : 'negative'}">${f.status}</td>
            </tr>
          `).join('')}
        </table>
        
        <h4>üìä –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –≤–∫–ª–∞–¥–∞</h4>
        <div class="chart-container">
          <canvas id="pieChart"></canvas>
        </div>
    `;

    // –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
    const badFibers = fibers.filter(f => f.status !== "‚úÖ –ù–æ—Ä–º–∞");
    if (badFibers.length > 0 && C < 1) {
      resultHTML += `
        <h4>üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:</h4>
        <ul>
          ${badFibers.map(f => `
            <li>
              <strong>${fiberNames[f.num] || `–í–æ–ª–æ–∫–Ω–æ ${f.num}`}</strong>: 
              ${f.d > 1.1 ? `–£–º–µ–Ω—å—à–∏—Ç–µ –ø–æ–º–µ—Ö–∏ (—Å–µ–π—á–∞—Å ${f.d})` : `–£—Å–∏–ª—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å (—Å–µ–π—á–∞—Å ${f.w})`}
            </li>
          `).join('')}
        </ul>
      `;
    }

    resultHTML += `</div>`;

    // –í—Å—Ç–∞–≤–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
    document.getElementById('flow-result').innerHTML = resultHTML;

    // –°–æ–∑–¥–∞–Ω–∏–µ –∫—Ä—É–≥–æ–≤–æ–π –¥–∏–∞–≥—Ä–∞–º–º—ã
    setTimeout(() => {
      const ctx = document.getElementById('pieChart')?.getContext('2d');
      if (ctx) {
        // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â—É—é –¥–∏–∞–≥—Ä–∞–º–º—É, –µ—Å–ª–∏ –æ–Ω–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        if (window.pieChartInstance) {
          window.pieChartInstance.destroy();
        }
        
        window.pieChartInstance = new Chart(ctx, {
          type: 'pie',
          data: {
            labels: fibers.map(f => {
              const name = fiberNames[f.num] || `–í–æ–ª–æ–∫–Ω–æ ${f.num}`;
              return `${name} (${f.contribution})`;
            }),
            datasets: [{
              data: fibers.map(f => parseFloat(f.contribution)),
              backgroundColor: [
                '#4e79a7', '#f28e2b', '#e15759', '#76b7b2', '#59a14f', '#edc948', '#b07aa1'
              ],
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              title: {
                display: true,
                text: `–ö–æ–º–ø–ª–µ–º–µ–Ω—Ç–∞—Ä–Ω–æ—Å—Ç—å (C = ${C})`,
                font: {
                  size: 16
                }
              },
              legend: {
                position: 'right',
              },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    const label = context.label || '';
                    const value = context.raw || 0;
                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                    const percentage = Math.round((value / total) * 100);
                    return `${label}: ${value} (${percentage}%)`;
                  }
                }
              }
            }
          }
        });
      }
    }, 100);
  }

  function exportData() {
    const data = {
      threads: db,
      flowResults: flowResults
    };
    
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'niti_export_' + new Date().toISOString().slice(0, 10) + '.json';
    a.click();
    URL.revokeObjectURL(url);
  }

  function importData(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
      try {
        const imported = JSON.parse(e.target.result);
        
        if (imported.threads) {
          db = imported.threads;
          localStorage.setItem(STORAGE_KEY, JSON.stringify(db));
        }
        
        if (imported.flowResults) {
          flowResults = imported.flowResults;
          localStorage.setItem(FLOW_STORAGE_KEY, JSON.stringify(flowResults));
        }
        
        updateHistory();
        updateChart();
        alert("‚úÖ –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã");
      } catch (err) {
        console.error(err);
        alert("‚ùå –û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: " + err.message);
      }
    };
    reader.readAsText(file);
  }

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
  function initApp() {
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ–≥–æ–¥–Ω—è—à–Ω—é—é –¥–∞—Ç—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('thread-date').value = today;
    
    updateHistory();
    updateChart();
  }

  window.onload = initApp;
</script>

</body>
</html>
