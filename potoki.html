<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>üí´ –ü–æ—Ç–æ–∫ –°–æ–∑–Ω–∞–Ω–∏—è</title>
  <style>
    :root {
      --primary-bg: #f4f7fa;
      --primary-text: #2c3e50;
      --section-bg: white;
      --shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      --button-bg: #2980b9;
      --button-hover: #1a6ca8;
      --border-color: #ccc;
      --table-header: #f8f9fa;
      --table-border: #eee;
      --positive: #2ecc71;
      --negative: #e74c3c;
    }

    .dark-mode {
      --primary-bg: #1a1a1a;
      --primary-text: #f5f5f5;
      --section-bg: #2c2c2c;
      --shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      --button-bg: #3a7ca5;
      --button-hover: #2c6a8d;
      --border-color: #555;
      --table-header: #333;
      --table-border: #444;
    }

    body {
      font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--primary-bg);
      color: var(--primary-text);
      margin: 0;
      padding: 0;
      transition: all 0.3s ease;
      line-height: 1.5;
    }

    header {
      background: #2c3e50;
      color: white;
      padding: 1em;
      text-align: center;
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
    }

    main {
      width: 95%;
      max-width: 960px;
      margin: 0 auto;
      padding: 1em;
    }

    .section {
      background: var(--section-bg);
      padding: 1.5em;
      margin-bottom: 1.5em;
      border-radius: 10px;
      box-shadow: var(--shadow);
    }

    h1, h2, h3 {
      margin-top: 0;
    }

    h2 {
      color: #34495e;
      font-size: 1.4rem;
    }

    .dark-mode h2 {
      color: #ecf0f1;
    }

    label {
      display: block;
      margin-top: 1em;
      font-weight: bold;
    }

    input,
    select,
    textarea {
      width: 100%;
      padding: 0.75em;
      margin-top: 0.5em;
      border: 1px solid var(--border-color);
      border-radius: 5px;
      font-size: 1rem;
      box-sizing: border-box;
    }

    button {
      margin-top: 1em;
      padding: 0.75em 1.5em;
      background: var(--button-bg);
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.3s;
      font-size: 1rem;
      min-height: 44px;
    }

    button:hover {
      background: var(--button-hover);
    }

    .delete-btn {
      background: #e74c3c;
      padding: 0.5em 1em;
      font-size: 0.9rem;
    }

    .delete-btn:hover {
      background: #c0392b;
    }

    .add-fiber-btn {
      background: #2ecc71;
    }

    .add-fiber-btn:hover {
      background: #27ae60;
    }

    .theme-toggle, .help-toggle {
      padding: 0.5em 1em;
      font-size: 0.9rem;
    }

    .fiber-inputs {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 0.75rem;
      margin-top: 1rem;
    }

    .fiber-input-group {
      display: flex;
      flex-direction: column;
    }

    .chart-container {
      position: relative;
      height: 300px;
      margin: 1em 0;
    }

    canvas {
      max-width: 100%;
      height: auto !important;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin: 1em 0;
      font-size: 0.9rem;
    }

    th, td {
      padding: 0.75em;
      text-align: left;
      border-bottom: 1px solid var(--table-border);
    }

    th {
      background-color: var(--table-header);
      font-weight: bold;
    }

    .positive { color: var(--positive); }
    .negative { color: var(--negative); }

    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.7);
    }

    .modal-content {
      background-color: var(--section-bg);
      margin: 5% auto;
      padding: 1.5em;
      border-radius: 10px;
      width: 90%;
      max-width: 700px;
      max-height: 80vh;
      overflow-y: auto;
    }

    .close {
      color: #aaa;
      float: right;
      font-size: 1.75em;
      font-weight: bold;
      cursor: pointer;
    }

    .close:hover {
      color: var(--primary-text);
    }

    /* –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ */
    @media (max-width: 768px) {
      header {
        flex-direction: column;
        padding: 0.75em;
      }

      .section {
        padding: 1em;
      }

      .fiber-inputs {
        grid-template-columns: 1fr;
        gap: 0.5rem;
      }

      .fiber-input-group {
        margin-bottom: 0.5rem;
      }

      table {
        display: block;
        overflow-x: auto;
        white-space: nowrap;
      }

      .modal-content {
        width: 95%;
        padding: 1em;
        margin: 10% auto;
      }

      .chart-container {
        height: 250px;
      }
    }

    @media (max-width: 480px) {
      body {
        font-size: 15px;
      }

      h1 {
        font-size: 1.5rem;
      }

      h2 {
        font-size: 1.2rem;
      }

      input, select, textarea, button {
        font-size: 16px;
      }

      button {
        width: 100%;
      }

      .chart-container {
        height: 200px;
      }
    }
  </style>
</head>
<body>

<header>
  <h1>üí´ –ü–æ—Ç–æ–∫ –°–æ–∑–Ω–∞–Ω–∏—è</h1>
  <button class="help-toggle" onclick="showHelpModal()">‚ùì –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç</button>
  <button class="theme-toggle" onclick="toggleTheme()">üåô –¢–µ–º–Ω–∞—è —Ç–µ–º–∞</button>
</header>

<main>

  <!-- 1. –î–Ω–µ–≤–Ω–∏–∫ –Ω–∏—Ç–µ–π -->
  <div class="section">
    <h2>üìù –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ø–æ—Ç–æ–∫–∞</h2>
    <label>–î–∞—Ç–∞:</label>
    <input type="date" id="thread-date">
    <label>–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–∏—Ç–∏:</label>
    <input type="text" id="thread-name" placeholder="–ü—Ä–∏–º–µ—Ä: '–Ω–∏—Ç—å —Å—Ç—Ä–∞—Ö–∞' –∏–ª–∏ '–Ω–∏—Ç—å –º–∏—Å—Å–∏–∏'">
    <label>–¢–∏–ø –Ω–∏—Ç–∏:</label>
    <select id="thread-type">
      <option value="—Ñ–∏–∑–∏—á–µ—Å–∫–∞—è">–§–∏–∑–∏—á–µ—Å–∫–∞—è</option>
      <option value="—ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è">–≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è</option>
      <option value="–º–µ–Ω—Ç–∞–ª—å–Ω–∞—è">–ú–µ–Ω—Ç–∞–ª—å–Ω–∞—è</option>
      <option value="—Å–æ—Ü–∏–∞–ª—å–Ω–∞—è">–°–æ—Ü–∏–∞–ª—å–Ω–∞—è</option>
      <option value="–¥—É—Ö–æ–≤–Ω–∞—è">–î—É—Ö–æ–≤–Ω–∞—è</option>
      <option value="–≤—Ä–µ–º–µ–Ω–Ω–∞—è">–í—Ä–µ–º–µ–Ω–Ω–∞—è</option>
    </select>
    <label>–°–æ—Å—Ç–æ—è–Ω–∏–µ:</label>
    <input type="text" id="thread-state" placeholder="–ö–∞–∫ –ø—Ä–æ—è–≤–ª—è–µ—Ç—Å—è? –ß—Ç–æ –≤—ã–∑—ã–≤–∞–µ—Ç?">
    <label>–û–ø–∏—Å–∞–Ω–∏–µ:</label>
    <textarea id="thread-desc" rows="4" placeholder="–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è –Ω–∏—Ç–∏"></textarea>
    <label>–ì–∞—Ä–º–æ–Ω–∏–∑–∞—Ü–∏—è:</label>
    <textarea id="thread-harmonize" rows="3" placeholder="–ß—Ç–æ –ø–æ–º–æ–∂–µ—Ç –≤—ã—Ä–æ–≤–Ω—è—Ç—å —ç—Ç—É –Ω–∏—Ç—å?"></textarea>
    <button onclick="saveThread()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å</button>
  </div>

  <!-- 2. –†–∞—Å—á—ë—Ç –ø–æ—Ç–æ–∫–∞ -->
  <div class="section">
    <h2>üßÆ –ê–Ω–∞–ª–∏–∑ –ü–æ—Ç–æ–∫–∞ –°–æ–∑–Ω–∞–Ω–∏—è</h2>
    <p><strong>–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Ñ–æ–∫—É—Å–∞ –∏ –∫–æ–º–ø–ª–µ–º–µ–Ω—Ç–∞—Ä–Ω–æ—Å—Ç–∏ –Ω–∏—Ç–µ–π.</strong></p>
    
    <label>–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏:</label>
    <input type="text" id="task-name" placeholder="–û–ø–∏—à–∏—Ç–µ —Ç–µ–∫—É—â—É—é –∑–∞–¥–∞—á—É">
    
    <label>–í—Ä–µ–º—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ T (–º–∏–Ω):</label>
    <input type="number" id="T" value="5">
    
    <label>–ù–∞—á–∞–ª—å–Ω—ã–π —Ñ–æ–∫—É—Å A‚ÇÄ (%):</label>
    <input type="number" id="A0" value="100" min="0" max="100">
    
    <label>–¢–µ–∫—É—â–∏–π —Ñ–æ–∫—É—Å A‚Çú (%):</label>
    <input type="number" id="At" value="30" min="0" max="100">
    
    <div id="fiber-inputs-container">
      <h3>–í–æ–ª–æ–∫–Ω–∞:</h3>
      <div class="fiber-inputs">
        <div class="fiber-input-group">
          <label>–ò–º—è –≤–æ–ª–æ–∫–Ω–∞</label>
          <input type="text" class="fiber-name" value="–ö–æ–≥–Ω–∏—Ç–∏–≤–Ω–æ–µ" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
        </div>
        <div class="fiber-input-group">
          <label>k·µ¢ (–≤–∞–∂–Ω–æ—Å—Ç—å)</label>
          <input type="number" class="fiber-k" value="0.5" step="0.1" min="0" max="1">
        </div>
        <div class="fiber-input-group">
          <label>w·µ¢ (–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å)</label>
          <input type="number" class="fiber-w" value="1.0" step="0.1" min="0" max="1">
        </div>
        <div class="fiber-input-group">
          <label>d·µ¢ (–ø–æ–º–µ—Ö–∏)</label>
          <input type="number" class="fiber-d" value="1.0" step="0.1" min="0.1">
        </div>
      </div>
      
      <div class="fiber-inputs">
        <div class="fiber-input-group">
          <input type="text" class="fiber-name" value="–≠–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–æ–µ" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
        </div>
        <div class="fiber-input-group">
          <input type="number" class="fiber-k" value="0.3" step="0.1" min="0" max="1">
        </div>
        <div class="fiber-input-group">
          <input type="number" class="fiber-w" value="0.8" step="0.1" min="0" max="1">
        </div>
        <div class="fiber-input-group">
          <input type="number" class="fiber-d" value="1.2" step="0.1" min="0.1">
        </div>
      </div>
      
      <div class="fiber-inputs">
        <div class="fiber-input-group">
          <input type="text" class="fiber-name" value="–ò–Ω—Ç—É–∏—Ç–∏–≤–Ω–æ–µ" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
        </div>
        <div class="fiber-input-group">
          <input type="number" class="fiber-k" value="0.2" step="0.1" min="0" max="1">
        </div>
        <div class="fiber-input-group">
          <input type="number" class="fiber-w" value="0.5" step="0.1" min="0" max="1">
        </div>
        <div class="fiber-input-group">
          <input type="number" class="fiber-d" value="0.9" step="0.1" min="0.1">
        </div>
      </div>
    </div>
    
    <button class="add-fiber-btn" onclick="addFiberInput()">+ –î–æ–±–∞–≤–∏—Ç—å –≤–æ–ª–æ–∫–Ω–æ</button>
    <button onclick="calculateFlow()">üìä –†–∞—Å—Å—á–∏—Ç–∞—Ç—å</button>
  </div>

  <!-- 3. –í—ã–≤–æ–¥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ -->
  <div id="flow-result" style="margin-top: 20px;"></div>

  <!-- 4. –ì—Ä–∞—Ñ–∏–∫ –¥–∏–Ω–∞–º–∏–∫–∏ -->
  <div class="section">
  <h2>üìà –ì—Ä–∞—Ñ –¥–∏–Ω–∞–º–∏–∫–∏ –Ω–∏—Ç–µ–π</h2>
  <div id="threadChartContainer">
    <canvas id="threadChart" height="100"></canvas>
    <div id="noDataMessage" style="display: none; text-align: center; padding: 20px; color: #666;">
      –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è. –î–æ–±–∞–≤—å—Ç–µ –∑–∞–ø–∏—Å–∏ –≤ ¬´–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ø–æ—Ç–æ–∫–∞.
    </div>
    <button onclick="downloadChart('threadChart')" style="display: none;">üíæ –°–∫–∞—á–∞—Ç—å –≥—Ä–∞—Ñ–∏–∫</button>
  </div>
</div>

  <!-- 5. –ò—Å—Ç–æ—Ä–∏—è –∑–∞–ø–∏—Å–µ–π -->
  <div class="section">
    <h2>üìñ –ò—Å—Ç–æ—Ä–∏—è –∑–∞–ø–∏—Å–µ–π</h2>
    <ul id="history-list"></ul>
  </div>

  <!-- 6. –ò—Å—Ç–æ—Ä–∏—è —Ä–∞—Å—á–µ—Ç–æ–≤ -->
  <div class="section">
    <h2>üìä –ò—Å—Ç–æ—Ä–∏—è —Ä–∞—Å—á–µ—Ç–æ–≤</h2>
    <div id="flow-history-list"></div>
  </div>

  <!-- 7. –ß–∞–∫—Ä—ã -->
  <div class="section">
    <h2>üåÄ –ù–∏—Ç–∏ –∏ —á–∞–∫—Ä—ã</h2>
    <ul>
      <li><strong>–ö–æ—Ä–Ω–µ–≤–∞—è</strong>: —Ñ–∏–∑–∏—á–µ—Å–∫–æ–µ –≤—ã–∂–∏–≤–∞–Ω–∏–µ ‚Üí —Ñ–∏–∑–∏—á–µ—Å–∫–∏–µ –∏ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –Ω–∏—Ç–∏</li>
      <li><strong>–°–∞–∫—Ä–∞–ª—å–Ω–∞—è</strong>: —ç–º–æ—Ü–∏–∏ –∏ —Ç–≤–æ—Ä—á–µ—Å—Ç–≤–æ ‚Üí —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –∏ —Å–æ—Ü–∏–∞–ª—å–Ω—ã–µ –Ω–∏—Ç–∏</li>
      <li><strong>–°–æ–ª–Ω–µ—á–Ω–æ–µ —Å–ø–ª–µ—Ç–µ–Ω–∏–µ</strong>: –ª–∏—á–Ω–∞—è —Å–∏–ª–∞ ‚Üí –º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ –∏ —Å–æ—Ü–∏–∞–ª—å–Ω—ã–µ –Ω–∏—Ç–∏</li>
      <li><strong>–°–µ—Ä–¥—Ü–µ</strong>: –ª—é–±–æ–≤—å ‚Üí –¥—É—Ö–æ–≤–Ω—ã–µ –∏ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –Ω–∏—Ç–∏</li>
      <li><strong>–ì–æ—Ä–ª–æ</strong>: –≤—ã—Ä–∞–∂–µ–Ω–∏–µ ‚Üí –º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ –∏ —Å–æ—Ü–∏–∞–ª—å–Ω—ã–µ –Ω–∏—Ç–∏</li>
      <li><strong>–¢—Ä–µ—Ç–∏–π –≥–ª–∞–∑</strong>: –∏–Ω—Ç—É–∏—Ü–∏—è ‚Üí –¥—É—Ö–æ–≤–Ω—ã–µ –∏ –º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ –Ω–∏—Ç–∏</li>
      <li><strong>–ú–∞–∫—É—à–∫–∞</strong>: —Å–≤—è–∑—å —Å –í—ã—Å—à–∏–º –Ø ‚Üí –¥—É—Ö–æ–≤–Ω—ã–µ –∏ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –Ω–∏—Ç–∏</li>
    </ul>
  </div>

  <!-- 8. –ú–µ–¥–∏—Ç–∞—Ü–∏—è -->
  <div class="section">
    <h2>üßò‚Äç‚ôÄÔ∏è –ú–µ–¥–∏—Ç–∞—Ü–∏—è</h2>
    <button onclick="changeMeditation()">üîÑ –°–º–µ–Ω–∏—Ç—å –º–µ–¥–∏—Ç–∞—Ü–∏—é</button>
    <div id="meditation-content">
      <p><strong>–¶–µ–ª—å:</strong> –æ—á–∏—Å—Ç–∫–∞ –∏ —É—Å–∏–ª–µ–Ω–∏–µ –Ω–∏—Ç–µ–π —á–µ—Ä–µ–∑ —Ä–∞–±–æ—Ç—É —Å —Ç–æ—Ä–æ–º.</p>
      <ol id="meditation-steps">
        <li>–ó–∞–π–º–∏—Ç–µ —É–¥–æ–±–Ω—É—é –ø–æ–∑—É, –∑–∞–∫—Ä–æ–π—Ç–µ –≥–ª–∞–∑–∞.</li>
        <li>–ü—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ, –∫–∞–∫ –≤–∞—à–µ —Ç–æ—Ä–æ–≤–æ–µ –ø–æ–ª–µ –Ω–∞—á–∏–Ω–∞–µ—Ç —Å–≤–µ—Ç–∏—Ç—å—Å—è.</li>
        <li>–û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –æ–¥–Ω–æ–π –∏–∑ –≤–∞—à–∏—Ö –Ω–∏—Ç–µ–π.</li>
        <li>–ü–æ–ø—Ä–æ—Å–∏—Ç–µ –µ—ë –æ—Å–≤–µ—Ç–∏—Ç—å—Å—è –∏ –Ω–∞—á–∞—Ç—å –æ—á–∏—â–∞—Ç—å—Å—è.</li>
        <li>–ü–æ—á—É–≤—Å—Ç–≤—É–π—Ç–µ, –∫–∞–∫ –æ–Ω–∞ –Ω–∞–ø–æ–ª–Ω—è–µ—Ç –≤–∞—Å —Å–∏–ª–æ–π.</li>
        <li>–ó–∞–≤–µ—Ä—à–∏—Ç–µ –º–µ–¥–∏—Ç–∞—Ü–∏—é, –ø–æ–±–ª–∞–≥–æ–¥–∞—Ä–∏–≤ –∑–∞ –ø—Ä–æ—Ü–µ—Å—Å.</li>
      </ol>
    </div>
  </div>

  <!-- 9. –≠–∫—Å–ø–æ—Ä—Ç / –ò–º–ø–æ—Ä—Ç -->
  <div class="section">
    <h2>üì• –≠–∫—Å–ø–æ—Ä—Ç / –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö</h2>
    <button onclick="exportData()">üì§ –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
    <input type="file" id="importFile" accept=".json" onchange="importData()">
  </div>

</main>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- –û—Å–Ω–æ–≤–Ω–æ–π JS -->
<script>
  const STORAGE_KEY = 'threads_db';
  const FLOW_STORAGE_KEY = 'flow_results_db';
  const FIBER_NAMES_KEY = 'fiber_names';
  const THEME_KEY = 'theme_preference';
  
  let db = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
  let flowResults = JSON.parse(localStorage.getItem(FLOW_STORAGE_KEY)) || [];
  let fiberNames = JSON.parse(localStorage.getItem(FIBER_NAMES_KEY)) || {
    1: "–ö–æ–≥–Ω–∏—Ç–∏–≤–Ω–æ–µ",
    2: "–≠–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–æ–µ",
    3: "–ò–Ω—Ç—É–∏—Ç–∏–≤–Ω–æ–µ"
  };

  // –ú–µ–¥–∏—Ç–∞—Ü–∏–∏
  const meditations = [
    {
      title: "–ú–µ–¥–∏—Ç–∞—Ü–∏—è –Ω–∞ –≤–Ω–∏–º–∞–Ω–∏–µ",
      steps: [
        "–°—è–¥—å—Ç–µ —É–¥–æ–±–Ω–æ, –∑–∞–∫—Ä–æ–π—Ç–µ –≥–ª–∞–∑–∞ –∏ —Å–¥–µ–ª–∞–π—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ –≥–ª—É–±–æ–∫–∏—Ö –≤–¥–æ—Ö–æ–≤.",
        "–°–æ—Å—Ä–µ–¥–æ—Ç–æ—á—å—Ç–µ—Å—å –Ω–∞ —Å–≤–æ–µ–º –¥—ã—Ö–∞–Ω–∏–∏, –Ω–∞–±–ª—é–¥–∞—è –∑–∞ –∫–∞–∂–¥—ã–º –≤–¥–æ—Ö–æ–º –∏ –≤—ã–¥–æ—Ö–æ–º.",
        "–ö–æ–≥–¥–∞ –∑–∞–º–µ—Ç–∏—Ç–µ, —á—Ç–æ —É–º –æ—Ç–≤–ª–µ–∫—Å—è, –º—è–≥–∫–æ –≤–µ—Ä–Ω–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ –∫ –¥—ã—Ö–∞–Ω–∏—é.",
        "–†–∞—Å—à–∏—Ä—å—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ, –≤–∫–ª—é—á–∏–≤ –≤ –Ω–µ–≥–æ –∑–≤—É–∫–∏ –≤–æ–∫—Ä—É–≥ –≤–∞—Å.",
        "–ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ —Å—É–∑—å—Ç–µ —Ñ–æ–∫—É—Å –æ–±—Ä–∞—Ç–Ω–æ –∫ –¥—ã—Ö–∞–Ω–∏—é.",
        "–û—Ç–∫—Ä–æ–π—Ç–µ –≥–ª–∞–∑–∞, —Å–æ—Ö—Ä–∞–Ω—è—è —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ—Å–æ–∑–Ω–∞–Ω–Ω–æ—Å—Ç–∏."
      ]
    },
    {
      title: "–ú–µ–¥–∏—Ç–∞—Ü–∏—è –Ω–∞ –Ω–∏—Ç–∏",
      steps: [
        "–ó–∞–π–º–∏—Ç–µ —É–¥–æ–±–Ω–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ, –∑–∞–∫—Ä–æ–π—Ç–µ –≥–ª–∞–∑–∞.",
        "–ü—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ —ç–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–∏–µ –Ω–∏—Ç–∏, —Å–≤—è–∑—ã–≤–∞—é—â–∏–µ –≤–∞—Å —Å –º–∏—Ä–æ–º.",
        "–í—ã–±–µ—Ä–∏—Ç–µ –æ–¥–Ω—É –Ω–∏—Ç—å, –∫–æ—Ç–æ—Ä–∞—è —Ç—Ä–µ–±—É–µ—Ç –≤–Ω–∏–º–∞–Ω–∏—è.",
        "–ú—ã—Å–ª–µ–Ω–Ω–æ –æ—á–∏—Å—Ç–∏—Ç–µ –µ—ë, –Ω–∞–ø–æ–ª–Ω—è—è —Å–≤–µ—Ç–æ–º –∏ –≥–∞—Ä–º–æ–Ω–∏–µ–π.",
        "–ü—Ä–æ—Å–ª–µ–¥–∏—Ç–µ –ø—É—Ç—å –Ω–∏—Ç–∏, –æ—Å–æ–∑–Ω–∞–≤–∞—è –µ—ë –∑–Ω–∞—á–µ–Ω–∏–µ.",
        "–ü–æ–±–ª–∞–≥–æ–¥–∞—Ä–∏—Ç–µ –Ω–∏—Ç—å –∑–∞ –µ—ë —Ä–∞–±–æ—Ç—É –∏ –æ—Ç–∫—Ä–æ–π—Ç–µ –≥–ª–∞–∑–∞."
      ]
    },
    {
      title: "–ú–µ–¥–∏—Ç–∞—Ü–∏—è –Ω–∞ –ø–æ–ª–µ",
      steps: [
        "–ü—Ä–∏–º–∏—Ç–µ —É–¥–æ–±–Ω—É—é –ø–æ–∑—É, –∑–∞–∫—Ä–æ–π—Ç–µ –≥–ª–∞–∑–∞.",
        "–ü—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ —Å–≤–æ—ë —ç–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–ª–µ –≤–æ–∫—Ä—É–≥ —Ç–µ–ª–∞.",
        "–í–∏–∑—É–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –µ–≥–æ –∫–∞–∫ —Å—Ñ–µ—Ä–∏—á–µ—Å–∫–∏–π —Ç–æ—Ä (–±—É–±–ª–∏–∫) —Å–≤–µ—Ç–∞.",
        "–ù–∞–±–ª—é–¥–∞–π—Ç–µ, –∫–∞–∫ —ç–Ω–µ—Ä–≥–∏—è —Ü–∏—Ä–∫—É–ª–∏—Ä—É–µ—Ç –ø–æ —ç—Ç–æ–º—É —Ç–æ—Ä—É.",
        "–£—Å–∏–ª—å—Ç–µ —Å–≤–µ—á–µ–Ω–∏–µ, –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è—è —á–∏—Å—Ç—ã–π –±–µ–ª—ã–π —Å–≤–µ—Ç.",
        "–ú–µ–¥–ª–µ–Ω–Ω–æ –≤–µ—Ä–Ω–∏—Ç–µ—Å—å –≤ –æ–±—ã—á–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ–∑–Ω–∞–Ω–∏—è."
      ]
    }
  ];

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ–º—ã
  function initTheme() {
    const savedTheme = localStorage.getItem(THEME_KEY);
    if (savedTheme === 'dark') {
      document.body.classList.add('dark-mode');
      document.querySelector('.theme-toggle').textContent = '‚òÄÔ∏è –°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞';
      document.querySelector('.help-toggle').style.backgroundColor = '#3a7ca5';
    } else {
      document.querySelector('.help-toggle').style.backgroundColor = '#2980b9';
    }
  }

  // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–µ–º—ã
  function toggleTheme() {
    document.body.classList.toggle('dark-mode');
    const helpButton = document.querySelector('.help-toggle');
    
    if (document.body.classList.contains('dark-mode')) {
      localStorage.setItem(THEME_KEY, 'dark');
      document.querySelector('.theme-toggle').textContent = '‚òÄÔ∏è –°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞';
      helpButton.style.backgroundColor = '#3a7ca5';
    } else {
      localStorage.setItem(THEME_KEY, 'light');
      document.querySelector('.theme-toggle').textContent = 'üåô –¢–µ–º–Ω–∞—è —Ç–µ–º–∞';
      helpButton.style.backgroundColor = '#2980b9';
    }
  }

  // –°–º–µ–Ω–∞ –º–µ–¥–∏—Ç–∞—Ü–∏–∏
  function changeMeditation() {
    const randomIndex = Math.floor(Math.random() * meditations.length);
    const meditation = meditations[randomIndex];
    const content = document.getElementById('meditation-content');
    
    content.innerHTML = `
      <p><strong>${meditation.title}</strong></p>
      <ol>
        ${meditation.steps.map(step => `<li>${step}</li>`).join('')}
      </ol>
    `;
  }

  // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª–µ–π –¥–ª—è –Ω–æ–≤–æ–≥–æ –≤–æ–ª–æ–∫–Ω–∞
  function addFiberInput() {
    const container = document.getElementById('fiber-inputs-container');
    const newFiber = document.createElement('div');
    newFiber.className = 'fiber-inputs';
    newFiber.innerHTML = `
      <div class="fiber-input-group">
        <input type="text" class="fiber-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
      </div>
      <div class="fiber-input-group">
        <input type="number" class="fiber-k" value="0.5" step="0.1" min="0" max="1">
      </div>
      <div class="fiber-input-group">
        <input type="number" class="fiber-w" value="1.0" step="0.1" min="0" max="1">
      </div>
      <div class="fiber-input-group">
        <input type="number" class="fiber-d" value="1.0" step="0.1" min="0.1">
      </div>
    `;
    container.appendChild(newFiber);
  }

  // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–æ–≤–æ–π –∑–∞–ø–∏—Å–∏ –æ –Ω–∏—Ç–∏
  function saveThread() {
  const date = document.getElementById('thread-date').value;
  const name = document.getElementById('thread-name').value;
  const type = document.getElementById('thread-type').value;
  const state = document.getElementById('thread-state').value;
  const desc = document.getElementById('thread-desc').value;
  const harmonize = document.getElementById('thread-harmonize').value;

  if (!date || !name) {
    alert("‚ùó –£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É –∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–∏—Ç–∏");
    return;
  }

  const entry = { 
    date, name, type, state, desc, harmonize,
    timestamp: new Date().toISOString() 
  };
  
  db.push(entry);
  localStorage.setItem(STORAGE_KEY, JSON.stringify(db));
  
  updateHistory();
  updateChart();
  clearForm();
  
  // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –±–æ–ª—å—à–µ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è
  return;
}

  // –û—á–∏—Å—Ç–∫–∞ —Ñ–æ—Ä–º—ã –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
  function clearForm() {
    document.getElementById('thread-date').value = '';
    document.getElementById('thread-name').value = '';
    document.getElementById('thread-type').value = '—Ñ–∏–∑–∏—á–µ—Å–∫–∞—è'; // –∏–ª–∏ '–º–µ–Ω—Ç–∞–ª—å–Ω–∞—è', –µ—Å–ª–∏ —Ö–æ—á–µ—à—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    document.getElementById('thread-state').value = '';
    document.getElementById('thread-desc').value = '';
    document.getElementById('thread-harmonize').value = '';
  }

  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –∑–∞–ø–∏—Å–µ–π
  function updateHistory() {
    const list = document.getElementById('history-list');
    list.innerHTML = '';

    db.forEach(e => {
      list.innerHTML += `
        <li style="margin-bottom: 1em;">
          <strong>[${e.date}] ${e.name}</strong><br>
          –¢–∏–ø: ${e.type}<br> <!-- ‚úÖ –ó–¥–µ—Å—å –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ç–∏–ø -->
          –°–æ—Å—Ç–æ—è–Ω–∏–µ: ${e.state}<br>
          <small>–û–ø–∏—Å–∞–Ω–∏–µ: ${e.desc}</small><br>
          –ì–∞—Ä–º–æ–Ω–∏–∑–∞—Ü–∏—è: ${e.harmonize}<br>
          <button class="delete-btn" data-timestamp="${e.timestamp}">üóë –£–¥–∞–ª–∏—Ç—å</button>
        </li>
      `;
    });
  }

  // –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏
  function deleteThread(timestamp) {
    if (!timestamp || !confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–ø–∏—Å—å?")) return;
    
    db = db.filter(e => e.timestamp !== timestamp);
    localStorage.setItem(STORAGE_KEY, JSON.stringify(db));
    updateHistory();
    updateChart();
  }

  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞
  function updateChart() {
  const canvas = document.getElementById('threadChart');
  canvas.classList.add('updating'); // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å –∞–Ω–∏–º–∞—Ü–∏–∏
  const container = canvas.parentElement;
  const noDataMessage = document.getElementById('noDataMessage');
  const downloadBtn = document.querySelector('#threadChartContainer button'); // –ü–æ–ª—É—á–∞–µ–º –∫–Ω–æ–ø–∫—É —Å–∫–∞—á–∏–≤–∞–Ω–∏—è

  if (db.length === 0) {
    noDataMessage.style.display = 'block';
    canvas.style.display = 'none';
    downloadBtn.style.display = 'none'; // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
    if (window.threadChartInstance) {
      window.threadChartInstance.destroy();
    }
    return;
  }

  noDataMessage.style.display = 'none';
  canvas.style.display = 'block';
  downloadBtn.style.display = 'block'; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —Å–∫–∞—á–∏–≤–∞–Ω–∏—è

  // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞
  const ctx = canvas.getContext('2d');
  const labels = [...new Set(db.map(e => e.date))].sort();
  const types = ['—Ñ–∏–∑–∏—á–µ—Å–∫–∞—è', '—ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è', '–º–µ–Ω—Ç–∞–ª—å–Ω–∞—è', '—Å–æ—Ü–∏–∞–ª—å–Ω–∞—è', '–¥—É—Ö–æ–≤–Ω–∞—è', '–≤—Ä–µ–º–µ–Ω–Ω–∞—è'];
  
  const datasets = types.map(type => ({
    label: type,
    data: labels.map(date => db.filter(e => e.date === date && e.type === type).length),
    borderWidth: 1,
    fill: true,
    tension: 0.3
  }));

  // –£–Ω–∏—á—Ç–æ–∂–∞–µ–º —Å—Ç–∞—Ä—ã–π –≥—Ä–∞—Ñ–∏–∫ (–µ—Å–ª–∏ –±—ã–ª)
  if (window.threadChartInstance) {
    window.threadChartInstance.destroy();
  }

  // –°–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π –≥—Ä–∞—Ñ–∏–∫
  window.threadChartInstance = new Chart(ctx, {
    type: 'line',
    data: { labels, datasets },
    options: {
      responsive: true,
      scales: { y: { beginAtZero: true } }
    }
  });
  setTimeout(() => canvas.classList.remove('updating'), 300);
}

  // –†–∞—Å—á–µ—Ç –ø–æ—Ç–æ–∫–∞
  function calculateFlow() {
    const T = parseFloat(document.getElementById('T').value);
    const A0 = parseFloat(document.getElementById('A0').value);
    const At = parseFloat(document.getElementById('At').value);
    const task = document.getElementById('task-name').value;
    
    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ –≤–æ–ª–æ–∫–Ω–∞–º –∏–∑ –ø–æ–ª–µ–π –≤–≤–æ–¥–∞
    const fiberInputs = document.querySelectorAll('.fiber-inputs');
    const fibersData = [];
    
    fiberInputs.forEach((inputGroup, index) => {
      const name = inputGroup.querySelector('.fiber-name').value || `–í–æ–ª–æ–∫–Ω–æ ${index + 1}`;
      const k = parseFloat(inputGroup.querySelector('.fiber-k').value) || 0;
      const w = parseFloat(inputGroup.querySelector('.fiber-w').value) || 0;
      const d = parseFloat(inputGroup.querySelector('.fiber-d').value) || 1;
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–º—è –≤–æ–ª–æ–∫–Ω–∞
      fiberNames[index + 1] = name;
      
      fibersData.push({
        num: index + 1,
        name,
        k,
        w,
        d,
        contribution: (k * w / d).toFixed(2),
        status: d > 1.1 ? "‚ùó –ü–æ–º–µ—Ö–∏" : w < 0.5 ? "üîç –°–ª–∞–±–æ" : "‚úÖ –ù–æ—Ä–º–∞"
      });
    });
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–º–µ–Ω–∞ –≤–æ–ª–æ–∫–æ–Ω
    localStorage.setItem(FIBER_NAMES_KEY, JSON.stringify(fiberNames));

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö
    let errorMessage = "";
    if (isNaN(T) || isNaN(A0) || isNaN(At)) {
      errorMessage = "‚ùå T, A0, At –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —á–∏—Å–ª–∞–º–∏";
    } else if (fibersData.length === 0) {
      errorMessage = "‚ùå –î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –≤–æ–ª–æ–∫–Ω–æ";
    }

    if (errorMessage) {
      document.getElementById('flow-result').innerHTML = `
        <div class="section">
          <h3>–û—à–∏–±–∫–∞</h3>
          <p>${errorMessage}</p>
        </div>
      `;
      return;
    }

    // –†–∞—Å—á—ë—Ç—ã
    const fp = (1 / T) * Math.log(A0 / At);
    const C = fibersData.reduce((sum, f) => sum + parseFloat(f.contribution), 0).toFixed(2);

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    const flowResult = {
      timestamp: new Date().toISOString(),
      task,
      T, A0, At, fp, C,
      fibers: [...fibersData],
      date: new Date().toLocaleDateString()
    };
    
    flowResults.push(flowResult);
    localStorage.setItem(FLOW_STORAGE_KEY, JSON.stringify(flowResults));

    // –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
    let resultHTML = `
      <div class="section">
        <h3>üåä –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ—Ç–æ–∫–∞ ${task ? `"${task}"` : ''}</h3>
        
        <h4>üìà –†–µ–∑–æ–Ω–∞–Ω—Å–Ω–∞—è —á–∞—Å—Ç–æ—Ç–∞: ${fp.toFixed(2)} –ì—Ü</h4>
        <p class="math">f‚Çö = (1/T) ¬∑ ln(A‚ÇÄ/A‚Çú)</p>
        
        <table>
          <tr>
            <th>–ü–∞—Ä–∞–º–µ—Ç—Ä</th>
            <th>–ó–Ω–∞—á–µ–Ω–∏–µ</th>
            <th>–ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è</th>
          </tr>
          <tr>
            <td class="math">T</td>
            <td>${T} –º–∏–Ω</td>
            <td>${T} –º–∏–Ω—É—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</td>
          </tr>
          <tr>
            <td class="math">A‚ÇÄ ‚Üí A‚Çú</td>
            <td>${A0}% ‚Üí ${At}%</td>
            <td>–ü–æ—Ç–µ—Ä—è —Ñ–æ–∫—É—Å–∞: ${(100 - At).toFixed(0)}%</td>
          </tr>
          <tr>
            <td class="math">f‚Çö</td>
            <td>${fp.toFixed(2)} –ì—Ü</td>
            <td>${fp < 0.3 ? "–ì–ª—É–±–æ–∫–∏–π –ø–æ—Ç–æ–∫" : "–ê–∫—Ç–∏–≤–Ω—ã–π —Ä–µ–∂–∏–º"}</td>
          </tr>
        </table>
        
        <h4>üßÆ –ö–æ–º–ø–ª–µ–º–µ–Ω—Ç–∞—Ä–Ω–æ—Å—Ç—å –≤–æ–ª–æ–∫–æ–Ω: ${C} ${C >= 1 ? "‚úÖ" : "‚ùå"}</h4>
        <p class="math">C = Œ£(k·µ¢¬∑w·µ¢/d·µ¢)</p>
        
        <table>
          <tr>
            <th>–í–æ–ª–æ–∫–Ω–æ</th>
            <th class="math">k·µ¢</th>
            <th class="math">w·µ¢</th>
            <th class="math">d·µ¢</th>
            <th>–í–∫–ª–∞–¥</th>
            <th>–°—Ç–∞—Ç—É—Å</th>
          </tr>
          ${fibersData.map(f => `
            <tr>
              <td>${f.name}</td>
              <td>${f.k}</td>
              <td>${f.w}</td>
              <td>${f.d}</td>
              <td>${f.contribution}</td>
              <td class="${f.status.includes('‚úÖ') ? 'positive' : 'negative'}">${f.status}</td>
            </tr>
          `).join('')}
        </table>
        
        <h4>üìä –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –≤–∫–ª–∞–¥–∞</h4>
        <div class="chart-container">
          <canvas id="pieChart"></canvas>
          <button onclick="downloadChart('pieChart')">üíæ –°–∫–∞—á–∞—Ç—å –¥–∏–∞–≥—Ä–∞–º–º—É</button>
        </div>
    `;

    // –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
    const badFibers = fibersData.filter(f => f.status !== "‚úÖ –ù–æ—Ä–º–∞");
    if (badFibers.length > 0 && C < 1) {
      resultHTML += `
        <h4>üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:</h4>
        <ul>
          ${badFibers.map(f => `
            <li>
              <strong>${f.name}</strong>: 
              ${f.d > 1.1 ? `–£–º–µ–Ω—å—à–∏—Ç–µ –ø–æ–º–µ—Ö–∏ (—Å–µ–π—á–∞—Å ${f.d})` : `–£—Å–∏–ª—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å (—Å–µ–π—á–∞—Å ${f.w})`}
            </li>
          `).join('')}
        </ul>
      `;
    }

    resultHTML += `</div>`;

    // –í—Å—Ç–∞–≤–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
    document.getElementById('flow-result').innerHTML = resultHTML;

    // –°–æ–∑–¥–∞–Ω–∏–µ –∫—Ä—É–≥–æ–≤–æ–π –¥–∏–∞–≥—Ä–∞–º–º—ã
    setTimeout(() => {
      const ctx = document.getElementById('pieChart')?.getContext('2d');
      if (ctx) {
        if (window.pieChartInstance) {
          window.pieChartInstance.destroy();
        }
        
        window.pieChartInstance = new Chart(ctx, {
          type: 'pie',
          data: {
            labels: fibersData.map(f => `${f.name} (${f.contribution})`),
            datasets: [{
              data: fibersData.map(f => parseFloat(f.contribution)),
              backgroundColor: [
                '#4e79a7', '#f28e2b', '#e15759', '#76b7b2', '#59a14f', '#edc948', '#b07aa1'
              ],
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              title: {
                display: true,
                text: `–ö–æ–º–ø–ª–µ–º–µ–Ω—Ç–∞—Ä–Ω–æ—Å—Ç—å (C = ${C})`,
                font: {
                  size: 16
                }
              },
              legend: {
                position: 'right',
              },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    const label = context.label || '';
                    const value = context.raw || 0;
                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                    const percentage = Math.round((value / total) * 100);
                    return `${label}: ${value} (${percentage}%)`;
                  }
                }
              }
            }
          }
        });
      }
    }, 100);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é —Ä–∞—Å—á–µ—Ç–æ–≤
    updateFlowHistory();
  }

  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ —Ä–∞—Å—á–µ—Ç–æ–≤
  function updateFlowHistory() {
    const container = document.getElementById('flow-history-list');
    container.innerHTML = '';
    
    // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –¥–∞—Ç–µ (–Ω–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É)
    const sortedResults = [...flowResults].sort((a, b) => 
      new Date(b.timestamp) - new Date(a.timestamp));
    
    sortedResults.forEach(result => {
      const resultElement = document.createElement('div');
      resultElement.className = 'section';
      resultElement.style.marginTop = '10px';
      resultElement.style.padding = '10px';
      
      resultElement.innerHTML = `
        <h4>${result.task || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'} (${result.date})</h4>
        <p>f‚Çö: ${result.fp.toFixed(2)} –ì—Ü, C: ${result.C} ${result.C >= 1 ? "‚úÖ" : "‚ùå"}</p>
        <button class="delete-btn" onclick="deleteFlowResult('${result.timestamp}')">–£–¥–∞–ª–∏—Ç—å</button>
      `;
      
      container.appendChild(resultElement);
    });
  }

  // –£–¥–∞–ª–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ —Ä–∞—Å—á–µ—Ç–∞
  function deleteFlowResult(timestamp) {
    if (confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ä–∞—Å—á–µ—Ç?")) {
      flowResults = flowResults.filter(r => r.timestamp !== timestamp);
      localStorage.setItem(FLOW_STORAGE_KEY, JSON.stringify(flowResults));
      updateFlowHistory();
    }
  }

  // –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö
  function exportData() {
    const data = {
      threads: db,
      flowResults: flowResults,
      fiberNames: fiberNames,
      theme: document.body.classList.contains('dark-mode') ? 'dark' : 'light'
    };
    
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'niti_export_' + new Date().toISOString().slice(0, 10) + '.json';
    a.click();
    URL.revokeObjectURL(url);
  }

  // –ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö
  function importData(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
      try {
        const imported = JSON.parse(e.target.result);
        
        if (imported.threads) {
          db = imported.threads;
          localStorage.setItem(STORAGE_KEY, JSON.stringify(db));
        }
        
        if (imported.flowResults) {
          flowResults = imported.flowResults;
          localStorage.setItem(FLOW_STORAGE_KEY, JSON.stringify(flowResults));
        }
        
        if (imported.fiberNames) {
          fiberNames = imported.fiberNames;
          localStorage.setItem(FIBER_NAMES_KEY, JSON.stringify(fiberNames));
        }
        
        if (imported.theme === 'dark') {
          document.body.classList.add('dark-mode');
          document.querySelector('.theme-toggle').textContent = '‚òÄÔ∏è –°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞';
        } else {
          document.body.classList.remove('dark-mode');
          document.querySelector('.theme-toggle').textContent = 'üåô –¢–µ–º–Ω–∞—è —Ç–µ–º–∞';
        }
        
        updateHistory();
        updateChart();
        updateFlowHistory();
        alert("‚úÖ –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã");
      } catch (err) {
        console.error(err);
        alert("‚ùå –û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: " + err.message);
      }
    };
    reader.readAsText(file);
  }

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞
  function downloadChart(chartId) {
    const canvas = document.getElementById(chartId);
    const link = document.createElement('a');
    link.download = `${chartId}-${new Date().toISOString().slice(0, 10)}.png`;
    link.href = canvas.toDataURL('image/png');
    link.click();
  }

  // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–æ–¥–∞–ª—å–Ω—ã–º –æ–∫–Ω–æ–º
  function showHelpModal() {
    document.getElementById('helpModal').style.display = 'block';
  }
  
  function closeHelpModal() {
    document.getElementById('helpModal').style.display = 'none';
  }
  
  // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –æ–∫–Ω–∞
  window.onclick = function(event) {
    const modal = document.getElementById('helpModal');
    if (event.target == modal) {
      modal.style.display = 'none';
    }
  }

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
  function initApp() {
    initTheme();
    changeMeditation();
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ–≥–æ–¥–Ω—è—à–Ω—é—é –¥–∞—Ç—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('thread-date').value = today;
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–ø–∏—Å–µ–π
    document.getElementById('history-list').addEventListener('click', function(e) {
        if (e.target.classList.contains('delete-btn')) {
            const timestamp = e.target.getAttribute('data-timestamp');
            deleteThread(timestamp);
        }
    });
    
    updateHistory();
    updateChart();
    updateFlowHistory();
}

  window.onload = initApp;
</script>
<div id="helpModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeHelpModal()">&times;</span>
    <h2>üîç –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –∞–Ω–∞–ª–∏–∑ –ø–æ—Ç–æ–∫–∞ —Å–æ–∑–Ω–∞–Ω–∏—è</h2>
    <div class="modal-text">
      <h3>üìâ 1. –†–µ–∑–æ–Ω–∞–Ω—Å–Ω–∞—è —á–∞—Å—Ç–æ—Ç–∞ (f‚Çö)</h3>
      <p>–§–æ—Ä–º—É–ª–∞: <code>f‚Çö = (1 / T) ¬∑ ln(A‚ÇÄ / A‚Çú)</code></p>
      <p>–ì–¥–µ:</p>
      <ul>
        <li><strong>T</strong> ‚Äî –≤—Ä–µ–º—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (–º–∏–Ω—É—Ç—ã)</li>
        <li><strong>A‚ÇÄ</strong> ‚Äî –Ω–∞—á–∞–ª—å–Ω—ã–π —Ñ–æ–∫—É—Å (%)</li>
        <li><strong>A‚Çú</strong> ‚Äî —Ç–µ–∫—É—â–∏–π —Ñ–æ–∫—É—Å (%)</li>
      </ul>
      
      <p><strong>–ü—Ä–∏–º–µ—Ä:</strong><br>
      –ï—Å–ª–∏ T = 5 –º–∏–Ω, A‚ÇÄ = 100%, A‚Çú = 30%, —Ç–æ:<br>
      <code>f‚Çö = (1/5) ¬∑ ln(100/30) ‚âà 0.24 –ì—Ü</code></p>
      
      <p><strong>–ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è:</strong></p>
      <ul>
        <li><strong>f‚Çö < 0.3 –ì—Ü</strong> ‚Üí –ì–ª—É–±–æ–∫–∏–π –ø–æ—Ç–æ–∫ (–≤—ã—Å–æ–∫–∞—è –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è)</li>
        <li><strong>f‚Çö ‚â• 0.3 –ì—Ü</strong> ‚Üí –ê–∫—Ç–∏–≤–Ω—ã–π —Ä–µ–∂–∏–º (—Ä–∞—Å—Å–µ—è–Ω–Ω–æ–µ –≤–Ω–∏–º–∞–Ω–∏–µ)</li>
      </ul>
      
      <h3>üßµ 2. –ö–æ–º–ø–ª–µ–º–µ–Ω—Ç–∞—Ä–Ω–æ—Å—Ç—å –≤–æ–ª–æ–∫–æ–Ω (C)</h3>
      <p>–§–æ—Ä–º—É–ª–∞: <code>C = Œ£(k·µ¢ ¬∑ w·µ¢ / d·µ¢)</code></p>
      <p>–ì–¥–µ:</p>
      <ul>
        <li><strong>k·µ¢</strong> ‚Äî –≤–∞–∂–Ω–æ—Å—Ç—å –≤–æ–ª–æ–∫–Ω–∞ (0.1‚Äì1.0)</li>
        <li><strong>w·µ¢</strong> ‚Äî –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –≤–æ–ª–æ–∫–Ω–∞ (0‚Äì1.0)</li>
        <li><strong>d·µ¢</strong> ‚Äî —É—Ä–æ–≤–µ–Ω—å –ø–æ–º–µ—Ö (‚â•0.1)</li>
      </ul>
      
      <table>
        <tr><th>–í–æ–ª–æ–∫–Ω–æ</th><th>k·µ¢</th><th>w·µ¢</th><th>d·µ¢</th><th>–í–∫–ª–∞–¥ (k¬∑w/d)</th></tr>
        <tr><td>–ö–æ–≥–Ω–∏—Ç–∏–≤–Ω–æ–µ</td><td>0.5</td><td>1.0</td><td>1.0</td><td>0.50</td></tr>
        <tr><td>–≠–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–æ–µ</td><td>0.3</td><td>0.8</td><td>1.2</td><td>0.20</td></tr>
        <tr><td>–ò–Ω—Ç—É–∏—Ç–∏–≤–Ω–æ–µ</td><td>0.2</td><td>0.5</td><td>0.9</td><td>0.11</td></tr>
      </table>
      
      <p><strong>C = 0.50 + 0.20 + 0.11 = 0.81</strong></p>
      
      <p><strong>–ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è:</strong></p>
      <ul>
        <li><strong>C ‚â• 1.0</strong> ‚Üí –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ ‚úÖ</li>
        <li><strong>C < 1.0</strong> ‚Üí –¢—Ä–µ–±—É–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏ ‚ùå</li>
      </ul>
    </div>
  </div>
</div>
</body>
</html>
